#!/usr/bin/env bash
set -euo pipefail

# Usage: install_happ config.json <ADMIN_PORT>
CONFIG_FILE="$1"
ADMIN_PORT="${2:-4444}"   # default to 4444 if not provided

# ---- Parse JSON ----
APP_NAME=$(jq -r '.app.name' "$CONFIG_FILE")
APP_VERSION=$(jq -r '.app.version // "0.0.1"' "$CONFIG_FILE")
HAPP_URL=$(jq -r '.app.happUrl' "$CONFIG_FILE")
NETWORK_SEED=$(jq -r '.app.modifiers.networkSeed // empty' "$CONFIG_FILE")

# ---- Download happ file ----
HAPP_FILE="${APP_NAME}-${APP_VERSION}.happ"
echo "[*] Downloading happ from $HAPP_URL ..."
curl -sSL "$HAPP_URL" -o "$HAPP_FILE"

# ---- Generate agent key ----
echo "[*] Generating agent key..."
if hc s -f "$ADMIN_PORT" call new-agent | jq -e . >/dev/null 2>&1; then
  AGENT_KEY=$(hc s -f "$ADMIN_PORT" call new-agent | jq -r '.')
else
  AGENT_KEY=$(hc s -f "$ADMIN_PORT" call new-agent | awk '{print $NF}')
fi

# ---- Build App ID ----
APP_ID="${APP_NAME}::${APP_VERSION}::${AGENT_KEY}"
echo "[*] App ID = $APP_ID"

# ---- Install app ----
echo "[*] Installing app..."
hc s -f "$ADMIN_PORT" call install-app \
  --agent-key "$AGENT_KEY" \
  --app-id "$APP_ID" \
  "$HAPP_FILE" \
  "$NETWORK_SEED"

# ---- Enable app ----
echo "[*] Enabling app..."
hc s -f "$ADMIN_PORT" call enable-app "$APP_ID"

echo "[âœ”] App $APP_NAME ($APP_ID) installed and enabled!"